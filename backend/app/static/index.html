
<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Messenger</title>
<style>
body { font-family: Segoe UI, Roboto, Arial, sans-serif; background: linear-gradient(180deg, #00a884 18%, #121b22 18%); color: #e9edef; margin:0; padding:20px; }
.card { background: #111b21; border:1px solid #222e35; border-radius:12px; padding:16px; max-width:500px; margin:auto; }
input, select, textarea, button { width:100%; margin:4px 0; padding:10px; border-radius:8px; border:1px solid #2a3942; background:#1f2c33; color:#e9edef; outline:none; }
button { background:#00a884; font-weight:600; cursor:pointer; border:0; }
textarea { height:80px; resize:vertical; }
.dialog { background:#0b141a; border-radius:12px; padding:12px; height:300px; overflow:auto; margin:8px 0; }
.msg { margin:6px 0; display:flex; }
.msg.me { justify-content:flex-end; }
.msg.you { justify-content:flex-start; }
.bubble { padding:8px 12px; border-radius:12px; max-width:70%; background:#1f2c33; }
.msg.me .bubble { background:#005c4b; }
.name-label { display:block; font-size:12px; font-weight:600; color:#8bd3c7; margin-bottom:4px; }
.ts { display:block; font-size:11px; color:#8696a0; text-align:right; margin-top:4px; }
.hstack { display:flex; gap:8px; }
.muted { color:#8696a0; font-size:13px; }
.log { background:#0e0e0e; color:#d0ffd0; padding:8px; height:100px; overflow:auto; font-family: monospace; font-size:12px; border:1px solid #222e35; border-radius:8px; }
</style>
</head>
<body>

<div class="card">
  <h3>Чат</h3>
  <div class="hstack">
    <div class="muted">Вы: <span id="me">—</span></div>
    <div class="muted" style="margin-left:auto">JWT: <span id="jwt">—</span></div>
    <button style="width:auto" onclick="logout()">Выйти</button>
  </div>

  <div class="hstack">
    <button onclick="loadUsers()">Обновить пользователей</button>
    <button onclick="connectWs()">Подключить WS</button>
  </div>

  <select id="to_user"></select>
  <div id="dialog" class="dialog"></div>
  <input type="file" id="file" accept="image/*" />
  <textarea id="msg" placeholder="Введите сообщение"></textarea>
  <div class="hstack">
    <button onclick="sendWs()">Отправить</button>
    <button onclick="uploadAndSend()">Отправить фото</button>
  </div>
  <div id="log" class="log"></div>
</div>

<script>
let token = localStorage.getItem('auth_token');
let ws = null;
let users = [];
let meUser = null;
let messages = [];

function escapeHtml(s){ return s.replace(/[&<>"]+/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

function log(scope,text){
  const el=document.getElementById('log');
  el.textContent += `[${new Date().toLocaleTimeString()}] ${scope}: ${text}\n`;
  el.scrollTop=el.scrollHeight;
}

async function me() {
  if (!token) return;
  const r = await fetch('/auth/me', { headers: { 'Authorization': 'Bearer ' + token } });
  const data = await r.json();
  meUser = data;
  document.getElementById('me').textContent = meUser ? `${meUser.full_name || meUser.email} (#${meUser.id})` : '—';
}

async function loadUsers() {
  if (!token) return alert("Сначала войдите");
  const r = await fetch('/users/', { headers: { 'Authorization': 'Bearer ' + token } });
  users = await r.json();
  const sel = document.getElementById('to_user');
  sel.innerHTML = '<option value="">(всем)</option>' + users.map(u => `<option value="${u.id}">${u.full_name || u.email} (#${u.id})</option>`).join('');
}

function displayNameById(id){
  if(!id) return '';
  if(meUser && meUser.id===id) return 'Вы';
  const u=users.find(x=>x.id===id);
  return u ? (u.full_name || u.email || ('#'+id)) : ('#'+id);
}

function renderDialog(){
  const box=document.getElementById('dialog');
  const myId=meUser?.id;
  const peerId=Number(document.getElementById('to_user').value)||null;

  const filtered=messages.filter(m=>{
    if(!myId) return true;
    if(!peerId) return m.sender_id===myId || m.to_user_id===myId || m.to_user_id==null;
    const a=m.sender_id===myId && m.to_user_id===peerId;
    const b=m.sender_id===peerId && m.to_user_id===myId;
    return a||b;
  });

  box.innerHTML=filtered.map(m=>{
    const mine=m.sender_id===myId;
    const nameLabel=mine?'':`<span class="name-label">${escapeHtml(displayNameById(m.sender_id))}</span>`;
    const text=escapeHtml(m.text??'');
    const img=m.image_url?`<img src="${m.image_url}" style="max-width:260px;margin-top:6px;border-radius:8px;">`:'';
    const ts=`<span class="ts">${new Date().toLocaleTimeString()}</span>`;
    return `<div class="msg ${mine?'me':'you'}"><div class="bubble">${nameLabel}${text}${img}${ts}</div></div>`;
  }).join('');
  box.scrollTop=box.scrollHeight;
}

function connectWs() {
  if (!token) return alert("Сначала войдите");
  const url = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/chat/ws?token=' + encodeURIComponent(token);
  ws = new WebSocket(url);
  ws.onopen = () => log('ws', 'Соединение открыто');
  ws.onmessage = ev => {
    try {
      const obj = JSON.parse(ev.data);
      messages.push(obj);
      renderDialog();
    } catch(e){ log('ws','Ошибка:'+ev.data);}
  };
  ws.onclose = () => log('ws','Соединение закрыто');
}

function sendWs() {
  const text = document.getElementById('msg').value;
  const to_user_id = document.getElementById('to_user').value;
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ text, to_user_id: to_user_id || null }));
    document.getElementById('msg').value='';
  }
}

async function uploadAndSend() {
  if (!token) return alert("Сначала войдите");
  const fileInput = document.getElementById('file');
  if (!fileInput.files.length) return alert('Выберите файл');
  const fd = new FormData();
  fd.append('file', fileInput.files[0]);
  const r = await fetch('/media/upload', { method:'POST', headers:{'Authorization':'Bearer '+token}, body:fd });
  const data = await r.json();
  if (!data.url) return alert('Ошибка загрузки');
  const to_user_id = document.getElementById('to_user').value;
  if(ws && ws.readyState===WebSocket.OPEN) ws.send(JSON.stringify({ text:'', image_url:data.url, to_user_id: to_user_id||null }));
  fileInput.value='';
}

function logout(){
  try{ localStorage.removeItem('auth_token'); } catch{};
  try{ if(ws && ws.readyState===WebSocket.OPEN) ws.close(); } catch{};
  location.href='/ui/login.html';
}

window.addEventListener('DOMContentLoaded',()=>{
  token=localStorage.getItem('auth_token');
  const jwtEl = document.getElementById('jwt');
  if (jwtEl) jwtEl.textContent = token ? token.slice(0, 24) + '...' : '—';
  if(!token) location.href='/ui/login.html';
  me().then(loadUsers).then(connectWs);
});
</script>

</body>
</html>





