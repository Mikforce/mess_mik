<!--&lt;!&ndash;<!doctype html>&ndash;&gt;-->
<!--&lt;!&ndash;<html lang="ru">&ndash;&gt;-->
<!--&lt;!&ndash;<head>&ndash;&gt;-->
<!--&lt;!&ndash;  <meta charset="utf-8" />&ndash;&gt;-->
<!--&lt;!&ndash;  <meta name="viewport" content="width=device-width, initial-scale=1" />&ndash;&gt;-->
<!--&lt;!&ndash;  <title>Messenger UI</title>&ndash;&gt;-->
<!--&lt;!&ndash;  <style>&ndash;&gt;-->
<!--&lt;!&ndash;    :root {&ndash;&gt;-->
<!--&lt;!&ndash;      &#45;&#45;wa-bg: #0b141a;&ndash;&gt;-->
<!--&lt;!&ndash;      &#45;&#45;wa-panel: #111b21;&ndash;&gt;-->
<!--&lt;!&ndash;      &#45;&#45;wa-panel-light: #202c33;&ndash;&gt;-->
<!--&lt;!&ndash;      &#45;&#45;wa-text: #e9edef;&ndash;&gt;-->
<!--&lt;!&ndash;      &#45;&#45;wa-muted: #8696a0;&ndash;&gt;-->
<!--&lt;!&ndash;      &#45;&#45;wa-green: #00a884;&ndash;&gt;-->
<!--&lt;!&ndash;      &#45;&#45;wa-bubble-me: #005c4b;&ndash;&gt;-->
<!--&lt;!&ndash;      &#45;&#45;wa-bubble-you: #1f2c33;&ndash;&gt;-->
<!--&lt;!&ndash;    }&ndash;&gt;-->
<!--&lt;!&ndash;    * { box-sizing: border-box; }&ndash;&gt;-->
<!--&lt;!&ndash;    body { margin: 0; background: linear-gradient(180deg, #00a884 18%, #121b22 18%); font-family: Segoe UI, Roboto, Arial, sans-serif; color: var(&#45;&#45;wa-text); padding: 20px; }&ndash;&gt;-->
<!--&lt;!&ndash;    .row { display: flex; gap: 24px; align-items: flex-start; }&ndash;&gt;-->
<!--&lt;!&ndash;    .card { background: var(&#45;&#45;wa-panel); border: 1px solid #222e35; border-radius: 12px; padding: 16px; width: 360px; box-shadow: 0 6px 20px rgba(0,0,0,0.25); }&ndash;&gt;-->
<!--&lt;!&ndash;    input, button, textarea, select { font-size: 14px; padding: 10px; margin: 6px 0; width: 100%; border-radius: 8px; border: 1px solid #2a3942; background: #1f2c33; color: var(&#45;&#45;wa-text); outline: none; }&ndash;&gt;-->
<!--&lt;!&ndash;    button { background: var(&#45;&#45;wa-green); border: 0; color: white; font-weight: 600; cursor: pointer; }&ndash;&gt;-->
<!--&lt;!&ndash;    textarea { width: 100%; height: 120px; resize: vertical; }&ndash;&gt;-->
<!--&lt;!&ndash;    .log { background: #0e0e0e; color: #d0ffd0; padding: 8px; height: 110px; overflow: auto; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 12px; border: 1px solid #222e35; border-radius: 8px; }&ndash;&gt;-->
<!--&lt;!&ndash;    .dialog { border: 1px solid #222e35; border-radius: 12px; padding: 14px; height: 300px; overflow: auto; background: #0b141a;&ndash;&gt;-->
<!--&lt;!&ndash;      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200"><g fill="%23202c33" fill-opacity="0.35"><circle cx="20" cy="20" r="2"/><circle cx="60" cy="60" r="2"/><circle cx="100" cy="100" r="2"/><circle cx="140" cy="140" r="2"/><circle cx="180" cy="180" r="2"/></g></svg>'); }&ndash;&gt;-->
<!--&lt;!&ndash;    .msg { margin: 6px 0; display: flex; }&ndash;&gt;-->
<!--&lt;!&ndash;    .msg.me { justify-content: flex-end; }&ndash;&gt;-->
<!--&lt;!&ndash;    .msg.you { justify-content: flex-start; }&ndash;&gt;-->
<!--&lt;!&ndash;    .bubble { display: inline-block; padding: 8px 12px; border-radius: 12px; max-width: 70%; background: var(&#45;&#45;wa-bubble-you); color: var(&#45;&#45;wa-text); }&ndash;&gt;-->
<!--&lt;!&ndash;    .name-label { display:block; font-size: 12px; font-weight: 600; color: #8bd3c7; margin-bottom: 4px; }&ndash;&gt;-->
<!--&lt;!&ndash;    .msg.me .bubble { background: var(&#45;&#45;wa-bubble-me); }&ndash;&gt;-->
<!--&lt;!&ndash;    .bubble img { max-width: 260px; border-radius: 8px; display: block; margin-top: 6px; }&ndash;&gt;-->
<!--&lt;!&ndash;    .ts { display:block; text-align: right; font-size: 11px; color: var(&#45;&#45;wa-muted); margin-top: 4px; }&ndash;&gt;-->
<!--&lt;!&ndash;    .hstack { display: flex; gap: 8px; }&ndash;&gt;-->
<!--&lt;!&ndash;    .muted { color: var(&#45;&#45;wa-muted); font-size: 13px; }&ndash;&gt;-->
<!--&lt;!&ndash;  </style>&ndash;&gt;-->
<!--&lt;!&ndash;  <script>&ndash;&gt;-->
<!--&lt;!&ndash;    let token = localStorage.getItem('auth_token');&ndash;&gt;-->
<!--&lt;!&ndash;    let ws = null;&ndash;&gt;-->
<!--&lt;!&ndash;    let users = [];&ndash;&gt;-->
<!--&lt;!&ndash;    let meUser = null;&ndash;&gt;-->
<!--&lt;!&ndash;    let messages = [];&ndash;&gt;-->
<!--&lt;!&ndash;    let e2eePassword = '';&ndash;&gt;-->

<!--&lt;!&ndash;    async function registerUser() {&ndash;&gt;-->
<!--&lt;!&ndash;      const email = document.getElementById('reg_email').value;&ndash;&gt;-->
<!--&lt;!&ndash;      const password = document.getElementById('reg_password').value;&ndash;&gt;-->
<!--&lt;!&ndash;      const full_name = document.getElementById('reg_name').value;&ndash;&gt;-->
<!--&lt;!&ndash;      const r = await fetch('/auth/register', {&ndash;&gt;-->
<!--&lt;!&ndash;        method: 'POST',&ndash;&gt;-->
<!--&lt;!&ndash;        headers: { 'Content-Type': 'application/json' },&ndash;&gt;-->
<!--&lt;!&ndash;        body: JSON.stringify({ email, password, full_name })&ndash;&gt;-->
<!--&lt;!&ndash;      });&ndash;&gt;-->
<!--&lt;!&ndash;      const data = await r.json();&ndash;&gt;-->
<!--&lt;!&ndash;      log('register', JSON.stringify(data, null, 2));&ndash;&gt;-->
<!--&lt;!&ndash;    }&ndash;&gt;-->

<!--&lt;!&ndash;    async function loginUser() {&ndash;&gt;-->
<!--&lt;!&ndash;      const email = document.getElementById('login_email').value;&ndash;&gt;-->
<!--&lt;!&ndash;      const password = document.getElementById('login_password').value;&ndash;&gt;-->
<!--&lt;!&ndash;      const body = new URLSearchParams({ username: email, password });&ndash;&gt;-->
<!--&lt;!&ndash;      const r = await fetch('/auth/login', {&ndash;&gt;-->
<!--&lt;!&ndash;        method: 'POST',&ndash;&gt;-->
<!--&lt;!&ndash;        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },&ndash;&gt;-->
<!--&lt;!&ndash;        body&ndash;&gt;-->
<!--&lt;!&ndash;      });&ndash;&gt;-->
<!--&lt;!&ndash;      const data = await r.json();&ndash;&gt;-->
<!--&lt;!&ndash;      token = data.access_token;&ndash;&gt;-->
<!--&lt;!&ndash;      document.getElementById('jwt').textContent = token ? token.slice(0, 24) + '...' : '—';&ndash;&gt;-->
<!--&lt;!&ndash;      log('login', JSON.stringify(data, null, 2));&ndash;&gt;-->
<!--&lt;!&ndash;      // подтянем текущего пользователя и список пользователей автоматически&ndash;&gt;-->
<!--&lt;!&ndash;      await me();&ndash;&gt;-->
<!--&lt;!&ndash;      await loadUsers();&ndash;&gt;-->
<!--&lt;!&ndash;    }&ndash;&gt;-->

<!--&lt;!&ndash;    async function me() {&ndash;&gt;-->
<!--&lt;!&ndash;      const r = await fetch('/auth/me', { headers: { 'Authorization': 'Bearer ' + token } });&ndash;&gt;-->
<!--&lt;!&ndash;      const data = await r.json();&ndash;&gt;-->
<!--&lt;!&ndash;      meUser = data;&ndash;&gt;-->
<!--&lt;!&ndash;      document.getElementById('me').textContent = meUser ? `${meUser.full_name || meUser.email} (#${meUser.id})` : '—';&ndash;&gt;-->
<!--&lt;!&ndash;      log('me', JSON.stringify(data, null, 2));&ndash;&gt;-->
<!--&lt;!&ndash;    }&ndash;&gt;-->

<!--&lt;!&ndash;    async function loadUsers() {&ndash;&gt;-->
<!--&lt;!&ndash;      const r = await fetch('/users/', { headers: { 'Authorization': 'Bearer ' + token } });&ndash;&gt;-->
<!--&lt;!&ndash;      users = await r.json();&ndash;&gt;-->
<!--&lt;!&ndash;      const sel = document.getElementById('to_user');&ndash;&gt;-->
<!--&lt;!&ndash;      sel.innerHTML = '<option value="">(всем)</option>' + users.map(u => `<option value="${u.id}">${u.full_name || u.email} (#${u.id})</option>`).join('');&ndash;&gt;-->
<!--&lt;!&ndash;    }&ndash;&gt;-->

<!--&lt;!&ndash;    function connectWs() {&ndash;&gt;-->
<!--&lt;!&ndash;      if (!token) { return location.href = '/ui/login.html'; }&ndash;&gt;-->
<!--&lt;!&ndash;      const url = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/chat/ws?token=' + encodeURIComponent(token);&ndash;&gt;-->
<!--&lt;!&ndash;      ws = new WebSocket(url);&ndash;&gt;-->
<!--&lt;!&ndash;      ws.onopen = () => log('ws', 'Открыто соединение');&ndash;&gt;-->
<!--&lt;!&ndash;      ws.onmessage = (ev) => {&ndash;&gt;-->
<!--&lt;!&ndash;        try {&ndash;&gt;-->
<!--&lt;!&ndash;          const obj = JSON.parse(ev.data);&ndash;&gt;-->
<!--&lt;!&ndash;          log('ws', `От ${obj.sender_id}: ${obj.text}${obj.to_user_id ? ` -> ${obj.to_user_id}` : ''}`);&ndash;&gt;-->
<!--&lt;!&ndash;          messages.push(obj);&ndash;&gt;-->
<!--&lt;!&ndash;          renderDialog();&ndash;&gt;-->
<!--&lt;!&ndash;        } catch {&ndash;&gt;-->
<!--&lt;!&ndash;          log('ws', 'Сообщение: ' + ev.data);&ndash;&gt;-->
<!--&lt;!&ndash;        }&ndash;&gt;-->
<!--&lt;!&ndash;      };&ndash;&gt;-->
<!--&lt;!&ndash;      ws.onclose = () => log('ws', 'Закрыто соединение');&ndash;&gt;-->
<!--&lt;!&ndash;      ws.onerror = (e) => log('ws', 'Ошибка');&ndash;&gt;-->
<!--&lt;!&ndash;    }&ndash;&gt;-->

<!--&lt;!&ndash;    function sendWs() {&ndash;&gt;-->
<!--&lt;!&ndash;      const text = document.getElementById('msg').value;&ndash;&gt;-->
<!--&lt;!&ndash;      const to_user_id = document.getElementById('to_user').value;&ndash;&gt;-->
<!--&lt;!&ndash;      if (ws && ws.readyState === WebSocket.OPEN) {&ndash;&gt;-->
<!--&lt;!&ndash;        const payload = JSON.stringify({ text, to_user_id: to_user_id || null });&ndash;&gt;-->
<!--&lt;!&ndash;        ws.send(payload);&ndash;&gt;-->
<!--&lt;!&ndash;        // не добавляем локально — ждём эхо от сервера, чтобы не дублировать&ndash;&gt;-->
<!--&lt;!&ndash;        document.getElementById('msg').value = '';&ndash;&gt;-->
<!--&lt;!&ndash;      }&ndash;&gt;-->
<!--&lt;!&ndash;    }&ndash;&gt;-->

<!--&lt;!&ndash;    async function uploadAndSend() {&ndash;&gt;-->
<!--&lt;!&ndash;      if (!token) return (location.href = '/ui/login.html');&ndash;&gt;-->
<!--&lt;!&ndash;      const fileInput = document.getElementById('file');&ndash;&gt;-->
<!--&lt;!&ndash;      if (!fileInput.files.length) return alert('Выберите файл');&ndash;&gt;-->
<!--&lt;!&ndash;      const fd = new FormData();&ndash;&gt;-->
<!--&lt;!&ndash;      fd.append('file', fileInput.files[0]);&ndash;&gt;-->
<!--&lt;!&ndash;      const r = await fetch('/media/upload', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token }, body: fd });&ndash;&gt;-->
<!--&lt;!&ndash;      const data = await r.json();&ndash;&gt;-->
<!--&lt;!&ndash;      if (!data.url) return alert('Ошибка загрузки');&ndash;&gt;-->
<!--&lt;!&ndash;      const to_user_id = document.getElementById('to_user').value;&ndash;&gt;-->
<!--&lt;!&ndash;      if (ws && ws.readyState === WebSocket.OPEN) {&ndash;&gt;-->
<!--&lt;!&ndash;        const payload = JSON.stringify({ text: '', image_url: data.url, to_user_id: to_user_id || null });&ndash;&gt;-->
<!--&lt;!&ndash;        ws.send(payload);&ndash;&gt;-->
<!--&lt;!&ndash;        // не добавляем локально — ждём эхо от сервера, чтобы не дублировать&ndash;&gt;-->
<!--&lt;!&ndash;        fileInput.value = '';&ndash;&gt;-->
<!--&lt;!&ndash;      }&ndash;&gt;-->
<!--&lt;!&ndash;    }&ndash;&gt;-->

<!--&lt;!&ndash;    function log(scope, text) {&ndash;&gt;-->
<!--&lt;!&ndash;      const el = document.getElementById('log');&ndash;&gt;-->
<!--&lt;!&ndash;      const line = `[${new Date().toLocaleTimeString()}] ${scope}: ${text}\n`;&ndash;&gt;-->
<!--&lt;!&ndash;      el.textContent += line;&ndash;&gt;-->
<!--&lt;!&ndash;      el.scrollTop = el.scrollHeight;&ndash;&gt;-->
<!--&lt;!&ndash;    }&ndash;&gt;-->

<!--&lt;!&ndash;    function displayNameById(id) {&ndash;&gt;-->
<!--&lt;!&ndash;      if (!id) return '';&ndash;&gt;-->
<!--&lt;!&ndash;      if (meUser && meUser.id === id) return 'Вы';&ndash;&gt;-->
<!--&lt;!&ndash;      const u = users.find(x => x.id === id);&ndash;&gt;-->
<!--&lt;!&ndash;      return u ? (u.full_name || u.email || ('#'+id)) : ('#'+id);&ndash;&gt;-->
<!--&lt;!&ndash;    }&ndash;&gt;-->

<!--&lt;!&ndash;    function renderDialog() {&ndash;&gt;-->
<!--&lt;!&ndash;      const peer = document.getElementById('to_user').value;&ndash;&gt;-->
<!--&lt;!&ndash;      const box = document.getElementById('dialog');&ndash;&gt;-->
<!--&lt;!&ndash;      const myId = meUser?.id;&ndash;&gt;-->
<!--&lt;!&ndash;      const peer = document.getElementById('to_user').value;&ndash;&gt;-->
<!--&lt;!&ndash;      const myId = meUser?.id;&ndash;&gt;-->
<!--&lt;!&ndash;      const filtered = messages.filter(m => {&ndash;&gt;-->
<!--&lt;!&ndash;        if (!myId) return true; // пока не знаем мой id — показываем все, чтобы не скрывать сообщения&ndash;&gt;-->
<!--&lt;!&ndash;        // Общий режим: показываем только сообщения, где участвует текущий пользователь&ndash;&gt;-->
<!--&lt;!&ndash;        if (!peer) {&ndash;&gt;-->
<!--&lt;!&ndash;          return m.sender_id === myId || m.to_user_id === myId || m.to_user_id == null;&ndash;&gt;-->
<!--&lt;!&ndash;        }&ndash;&gt;-->
<!--&lt;!&ndash;        // Режим выбранного собеседника: только диалог 1:1 (без широковещательных)&ndash;&gt;-->
<!--&lt;!&ndash;        const peerId = Number(peer);&ndash;&gt;-->
<!--&lt;!&ndash;        const a = (m.sender_id === myId && m.to_user_id === peerId);&ndash;&gt;-->
<!--&lt;!&ndash;        const b = (m.sender_id === peerId && m.to_user_id === myId);&ndash;&gt;-->
<!--&lt;!&ndash;        return a || b;&ndash;&gt;-->
<!--&lt;!&ndash;      });&ndash;&gt;-->
<!--&lt;!&ndash;      box.innerHTML = filtered.map(m => {&ndash;&gt;-->
<!--&lt;!&ndash;        const mine = m.sender_id === myId;&ndash;&gt;-->
<!--&lt;!&ndash;        const text = escapeHtml(String(m.text ?? ''));&ndash;&gt;-->
<!--&lt;!&ndash;        const img = m.image_url ? `<img src="${m.image_url}" alt="image" />` : '';&ndash;&gt;-->
<!--&lt;!&ndash;        const ts = `<span class="ts">${new Date().toLocaleTimeString()}</span>`;&ndash;&gt;-->
<!--&lt;!&ndash;        const name = displayNameById(m.sender_id);&ndash;&gt;-->
<!--&lt;!&ndash;        const nameLabel = mine ? '' : `<span class="name-label">${escapeHtml(name)}</span>`;&ndash;&gt;-->
<!--&lt;!&ndash;        return `<div class="msg ${mine ? 'me' : 'you'}"><div class="bubble">${nameLabel}${text}${img}${ts}</div></div>`;&ndash;&gt;-->
<!--&lt;!&ndash;      }).join('');&ndash;&gt;-->
<!--&lt;!&ndash;      box.scrollTop = box.scrollHeight;&ndash;&gt;-->
<!--&lt;!&ndash;    }&ndash;&gt;-->

<!--&lt;!&ndash;    function escapeHtml(s) {&ndash;&gt;-->
<!--&lt;!&ndash;      return s.replace(/[&<>"]+/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));&ndash;&gt;-->
<!--&lt;!&ndash;    }&ndash;&gt;-->

<!--&lt;!&ndash;    // удалено клиентское шифрование — шифруем на бэке&ndash;&gt;-->
<!--&lt;!&ndash;  </script>&ndash;&gt;-->
<!--&lt;!&ndash;  <script>&ndash;&gt;-->
<!--&lt;!&ndash;    // Запускаем только после загрузки DOM, чтобы элементы уже существовали&ndash;&gt;-->
<!--&lt;!&ndash;    window.addEventListener('DOMContentLoaded', () => {&ndash;&gt;-->
<!--&lt;!&ndash;      token = localStorage.getItem('auth_token');&ndash;&gt;-->
<!--&lt;!&ndash;      if (!token) { location.href = '/ui/login.html'; return; }&ndash;&gt;-->
<!--&lt;!&ndash;      const jwtEl = document.getElementById('jwt');&ndash;&gt;-->
<!--&lt;!&ndash;      if (jwtEl) jwtEl.textContent = token ? token.slice(0, 24) + '...' : '—';&ndash;&gt;-->
<!--&lt;!&ndash;      // Автозагрузка профиля и списка&ndash;&gt;-->
<!--&lt;!&ndash;      me().then(loadUsers).then(connectWs).catch(() => {});&ndash;&gt;-->
<!--&lt;!&ndash;    });&ndash;&gt;-->

<!--&lt;!&ndash;    function logout() {&ndash;&gt;-->
<!--&lt;!&ndash;      try { localStorage.removeItem('auth_token'); } catch {}&ndash;&gt;-->
<!--&lt;!&ndash;      try { if (ws && ws.readyState === WebSocket.OPEN) ws.close(); } catch {}&ndash;&gt;-->
<!--&lt;!&ndash;      location.href = '/ui/login.html';&ndash;&gt;-->
<!--&lt;!&ndash;    }&ndash;&gt;-->
<!--&lt;!&ndash;  </script>&ndash;&gt;-->
<!--&lt;!&ndash;</head>&ndash;&gt;-->
<!--&lt;!&ndash;<body>&ndash;&gt;-->
<!--&lt;!&ndash;  <div class="row">&ndash;&gt;-->
<!--&lt;!&ndash;    <div class="card" style="flex:1">&ndash;&gt;-->
<!--&lt;!&ndash;      <h3>Чат</h3>&ndash;&gt;-->
<!--&lt;!&ndash;      <div class="hstack">&ndash;&gt;-->
<!--&lt;!&ndash;        <div class="muted">Вы: <span id="me">—</span></div>&ndash;&gt;-->
<!--&lt;!&ndash;        <div class="muted" style="margin-left:auto">JWT: <span id="jwt">—</span></div>&ndash;&gt;-->
<!--&lt;!&ndash;        <button style="width:auto" onclick="logout()">Выйти</button>&ndash;&gt;-->
<!--&lt;!&ndash;      </div>&ndash;&gt;-->
<!--&lt;!&ndash;      <div class="hstack">&ndash;&gt;-->
<!--&lt;!&ndash;        <button onclick="loadUsers()">Обновить пользователей</button>&ndash;&gt;-->
<!--&lt;!&ndash;        <button onclick="connectWs()">Подключить WS</button>&ndash;&gt;-->
<!--&lt;!&ndash;      </div>&ndash;&gt;-->
<!--&lt;!&ndash;      <select id="to_user"></select>&ndash;&gt;-->
<!--&lt;!&ndash;      <div id="dialog" class="dialog"></div>&ndash;&gt;-->
<!--&lt;!&ndash;      <input id="file" type="file" accept="image/*" />&ndash;&gt;-->
<!--&lt;!&ndash;      <textarea id="msg" placeholder="Введите сообщение"></textarea>&ndash;&gt;-->
<!--&lt;!&ndash;      <div class="hstack">&ndash;&gt;-->
<!--&lt;!&ndash;        <button onclick="sendWs()">Отправить</button>&ndash;&gt;-->
<!--&lt;!&ndash;        <button onclick="uploadAndSend()">Отправить фото</button>&ndash;&gt;-->
<!--&lt;!&ndash;      </div>&ndash;&gt;-->
<!--&lt;!&ndash;      <div id="log" class="log"></div>&ndash;&gt;-->
<!--&lt;!&ndash;    </div>&ndash;&gt;-->
<!--&lt;!&ndash;  </div>&ndash;&gt;-->
<!--&lt;!&ndash;</body>&ndash;&gt;-->
<!--&lt;!&ndash;</html>&ndash;&gt;-->


<!--<!doctype html>-->
<!--<html lang="ru">-->
<!--<head>-->
<!--<meta charset="utf-8">-->
<!--<meta name="viewport" content="width=device-width, initial-scale=1">-->
<!--<title>Messenger UI</title>-->
<!--<style>-->
<!--body { font-family: Arial, sans-serif; background: #121b22; color: #e9edef; padding: 20px; }-->
<!--input, button, select, textarea { margin: 4px 0; padding: 8px; width: 100%; }-->
<!--button { cursor: pointer; }-->
<!--.card { background: #1f2c33; padding: 16px; border-radius: 12px; max-width: 400px; margin-bottom: 20px; }-->
<!--.log { background: #0e0e0e; padding: 8px; height: 100px; overflow: auto; font-family: monospace; font-size: 12px; margin-top: 8px; }-->
<!--.dialog { background: #0b141a; padding: 8px; height: 200px; overflow: auto; margin-top: 8px; border-radius: 12px; }-->
<!--.msg { margin: 4px 0; }-->
<!--.msg.me { text-align: right; color: #00a884; }-->
<!--.msg.you { text-align: left; color: #8696a0; }-->
<!--</style>-->
<!--</head>-->
<!--<body>-->
<!--<div class="card">-->
<!--<h3>Регистрация</h3>-->
<!--<input id="reg_name" placeholder="Имя">-->
<!--<input id="reg_email" placeholder="Email">-->
<!--<input id="reg_password" placeholder="Пароль" type="password">-->
<!--<button onclick="registerUser()">Зарегистрироваться</button>-->
<!--</div>-->

<!--<div class="card">-->
<!--<h3>Логин</h3>-->
<!--<input id="login_email" placeholder="Email">-->
<!--<input id="login_password" placeholder="Пароль" type="password">-->
<!--<button onclick="loginUser()">Войти</button>-->
<!--<div>JWT: <span id="jwt">—</span></div>-->
<!--</div>-->

<!--<div class="card">-->
<!--<h3>Чат</h3>-->
<!--<div>Вы: <span id="me">—</span></div>-->
<!--<button onclick="loadUsers()">Обновить пользователей</button>-->
<!--<button onclick="connectWs()">Подключить WS</button>-->
<!--<select id="to_user"></select>-->
<!--<div id="dialog" class="dialog"></div>-->
<!--<input type="file" id="file">-->
<!--<textarea id="msg" placeholder="Введите сообщение"></textarea>-->
<!--<button onclick="sendWs()">Отправить сообщение</button>-->
<!--<button onclick="uploadAndSend()">Отправить фото</button>-->
<!--<div id="log" class="log"></div>-->
<!--</div>-->

<!--<script>-->
<!--let token = localStorage.getItem('auth_token');-->
<!--let ws = null;-->
<!--let users = [];-->
<!--let meUser = null;-->
<!--let messages = [];-->

<!--// -&#45;&#45; функции из твоего JS -&#45;&#45;-->
<!--async function registerUser() {-->
<!--  const email = document.getElementById('reg_email').value;-->
<!--  const password = document.getElementById('reg_password').value;-->
<!--  const full_name = document.getElementById('reg_name').value;-->
<!--  const r = await fetch('/auth/register', {-->
<!--    method: 'POST',-->
<!--    headers: { 'Content-Type': 'application/json' },-->
<!--    body: JSON.stringify({ email, password, full_name })-->
<!--  });-->
<!--  const data = await r.json();-->
<!--  log('register', JSON.stringify(data, null, 2));-->
<!--}-->

<!--async function loginUser() {-->
<!--  const email = document.getElementById('login_email').value;-->
<!--  const password = document.getElementById('login_password').value;-->
<!--  const body = new URLSearchParams({ username: email, password });-->
<!--  const r = await fetch('/auth/login', {-->
<!--    method: 'POST',-->
<!--    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },-->
<!--    body-->
<!--  });-->
<!--  const data = await r.json();-->
<!--  token = data.access_token;-->
<!--  document.getElementById('jwt').textContent = token ? token.slice(0, 24) + '...' : '—';-->
<!--  log('login', JSON.stringify(data, null, 2));-->
<!--  await me();-->
<!--  await loadUsers();-->
<!--}-->

<!--async function me() {-->
<!--  if (!token) return;-->
<!--  const r = await fetch('/auth/me', { headers: { 'Authorization': 'Bearer ' + token } });-->
<!--  const data = await r.json();-->
<!--  meUser = data;-->
<!--  document.getElementById('me').textContent = meUser ? `${meUser.full_name || meUser.email} (#${meUser.id})` : '—';-->
<!--  log('me', JSON.stringify(data, null, 2));-->
<!--}-->

<!--async function loadUsers() {-->
<!--  if (!token) return;-->
<!--  const r = await fetch('/users/', { headers: { 'Authorization': 'Bearer ' + token } });-->
<!--  users = await r.json();-->
<!--  const sel = document.getElementById('to_user');-->
<!--  sel.innerHTML = '<option value="">(всем)</option>' + users.map(u => `<option value="${u.id}">${u.full_name || u.email} (#${u.id})</option>`).join('');-->
<!--}-->

<!--function connectWs() {-->
<!--  if (!token) return alert("Сначала войдите");-->
<!--  const url = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/chat/ws?token=' + encodeURIComponent(token);-->
<!--  ws = new WebSocket(url);-->
<!--  ws.onopen = () => log('ws', 'Соединение открыто');-->
<!--  ws.onmessage = (ev) => {-->
<!--    try {-->
<!--      const obj = JSON.parse(ev.data);-->
<!--      messages.push(obj);-->
<!--      renderDialog();-->
<!--    } catch {-->
<!--      log('ws', 'Ошибка: ' + ev.data);-->
<!--    }-->
<!--  };-->
<!--  ws.onclose = () => log('ws', 'Соединение закрыто');-->
<!--}-->

<!--function sendWs() {-->
<!--  const text = document.getElementById('msg').value;-->
<!--  const to_user_id = document.getElementById('to_user').value;-->
<!--  if (ws && ws.readyState === WebSocket.OPEN) {-->
<!--    ws.send(JSON.stringify({ text, to_user_id: to_user_id || null }));-->
<!--    document.getElementById('msg').value = '';-->
<!--  }-->
<!--}-->

<!--async function uploadAndSend() {-->
<!--  if (!token) return alert("Сначала войдите");-->
<!--  const fileInput = document.getElementById('file');-->
<!--  if (!fileInput.files.length) return alert('Выберите файл');-->
<!--  const fd = new FormData();-->
<!--  fd.append('file', fileInput.files[0]);-->
<!--  const r = await fetch('/media/upload', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token }, body: fd });-->
<!--  const data = await r.json();-->
<!--  if (!data.url) return alert('Ошибка загрузки');-->
<!--  const to_user_id = document.getElementById('to_user').value;-->
<!--  if (ws && ws.readyState === WebSocket.OPEN) {-->
<!--    ws.send(JSON.stringify({ text: '', image_url: data.url, to_user_id: to_user_id || null }));-->
<!--    fileInput.value = '';-->
<!--  }-->
<!--}-->

<!--function log(scope, text) {-->
<!--  const el = document.getElementById('log');-->
<!--  el.textContent += `[${new Date().toLocaleTimeString()}] ${scope}: ${text}\n`;-->
<!--  el.scrollTop = el.scrollHeight;-->
<!--}-->

<!--function renderDialog() {-->
<!--  const box = document.getElementById('dialog');-->
<!--  const myId = meUser?.id;-->
<!--  const peerId = Number(document.getElementById('to_user').value) || null;-->
<!--  const filtered = messages.filter(m => !myId || (m.sender_id === myId || m.to_user_id === myId || m.to_user_id == null));-->
<!--  box.innerHTML = filtered.map(m => {-->
<!--    const mine = m.sender_id === myId;-->
<!--    return `<div class="msg ${mine ? 'me' : 'you'}">${m.text ?? ''}</div>`;-->
<!--  }).join('');-->
<!--}-->

<!--// Автологин если есть токен-->
<!--window.addEventListener('DOMContentLoaded', () => {-->
<!--  if (token) { me().then(loadUsers).then(connectWs); }-->
<!--});-->
<!--</script>-->
<!--</body>-->
<!--</html>-->






<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Messenger</title>
<style>
body { font-family: Segoe UI, Roboto, Arial, sans-serif; background: linear-gradient(180deg, #00a884 18%, #121b22 18%); color: #e9edef; margin:0; padding:20px; }
.card { background: #111b21; border:1px solid #222e35; border-radius:12px; padding:16px; max-width:500px; margin:auto; }
input, select, textarea, button { width:100%; margin:4px 0; padding:10px; border-radius:8px; border:1px solid #2a3942; background:#1f2c33; color:#e9edef; outline:none; }
button { background:#00a884; font-weight:600; cursor:pointer; border:0; }
textarea { height:80px; resize:vertical; }
.dialog { background:#0b141a; border-radius:12px; padding:12px; height:300px; overflow:auto; margin:8px 0; }
.msg { margin:6px 0; display:flex; }
.msg.me { justify-content:flex-end; }
.msg.you { justify-content:flex-start; }
.bubble { padding:8px 12px; border-radius:12px; max-width:70%; background:#1f2c33; }
.msg.me .bubble { background:#005c4b; }
.ts { display:block; font-size:11px; color:#8696a0; text-align:right; margin-top:4px; }
.hstack { display:flex; gap:8px; }
.muted { color:#8696a0; font-size:13px; }
</style>
</head>
<body>

<div class="card">
  <h3>Чат</h3>
  <div class="hstack">
    <div class="muted">Вы: <span id="me">—</span></div>
    <div class="muted" style="margin-left:auto">JWT: <span id="jwt">—</span></div>
    <button style="width:auto" onclick="logout()">Выйти</button>
  </div>

  <div class="hstack">
    <button onclick="loadUsers()">Обновить пользователей</button>
    <button onclick="connectWs()">Подключить WS</button>
  </div>

  <select id="to_user"></select>
  <div id="dialog" class="dialog"></div>
  <input type="file" id="file" accept="image/*" />
  <textarea id="msg" placeholder="Введите сообщение"></textarea>
  <div class="hstack">
    <button onclick="sendWs()">Отправить</button>
    <button onclick="uploadAndSend()">Отправить фото</button>
  </div>
  <div id="log" class="log" style="height:100px; overflow:auto;"></div>
</div>

<script>
let token = localStorage.getItem('auth_token');
let ws = null;
let users = [];
let meUser = null;
let messages = [];

async function me() {
  if (!token) return;
  const r = await fetch('/auth/me', { headers: { 'Authorization': 'Bearer ' + token } });
  const data = await r.json();
  meUser = data;
  document.getElementById('me').textContent = meUser ? `${meUser.full_name || meUser.email} (#${meUser.id})` : '—';
}

async function loadUsers() {
  if (!token) return alert("Сначала войдите");
  const r = await fetch('/users/', { headers: { 'Authorization': 'Bearer ' + token } });
  users = await r.json();
  const sel = document.getElementById('to_user');
  sel.innerHTML = '<option value="">(всем)</option>' + users.map(u => `<option value="${u.id}">${u.full_name || u.email} (#${u.id})</option>`).join('');
}

function connectWs() {
  if (!token) return alert("Сначала войдите");
  const url = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/chat/ws?token=' + encodeURIComponent(token);
  ws = new WebSocket(url);
  ws.onopen = () => log('ws', 'Соединение открыто');
  ws.onmessage = ev => {
    try {
      const obj = JSON.parse(ev.data);
      messages.push(obj);
      renderDialog();
    } catch(e){ log('ws','Ошибка:'+ev.data);}
  };
  ws.onclose = () => log('ws','Соединение закрыто');
}

function sendWs() {
  const text = document.getElementById('msg').value;
  const to_user_id = document.getElementById('to_user').value;
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ text, to_user_id: to_user_id || null }));
    document.getElementById('msg').value='';
  }
}

async function uploadAndSend() {
  if (!token) return alert("Сначала войдите");
  const fileInput = document.getElementById('file');
  if (!fileInput.files.length) return alert('Выберите файл');
  const fd = new FormData();
  fd.append('file', fileInput.files[0]);
  const r = await fetch('/media/upload', { method:'POST', headers:{'Authorization':'Bearer '+token}, body:fd });
  const data = await r.json();
  if (!data.url) return alert('Ошибка загрузки');
  const to_user_id = document.getElementById('to_user').value;
  if(ws && ws.readyState===WebSocket.OPEN) ws.send(JSON.stringify({ text:'', image_url:data.url, to_user_id: to_user_id||null }));
  fileInput.value='';
}

function log(scope,text){ const el=document.getElementById('log'); el.textContent += `[${new Date().toLocaleTimeString()}] ${scope}: ${text}\n`; el.scrollTop=el.scrollHeight; }

function escapeHtml(s){ return s.replace(/[&<>"]+/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

function renderDialog(){
  const box=document.getElementById('dialog');
  const myId=meUser?.id;
  const peerId=Number(document.getElementById('to_user').value)||null;
  const filtered=messages.filter(m=>{
    if(!myId) return true;
    if(!peerId) return m.sender_id===myId || m.to_user_id===myId || m.to_user_id==null;
    const a=m.sender_id===myId && m.to_user_id===peerId;
    const b=m.sender_id===peerId && m.to_user_id===myId;
    return a||b;
  });
  box.innerHTML=filtered.map(m=>{
    const mine=m.sender_id===myId;
    const text=escapeHtml(m.text??'');
    const img=m.image_url?`<img src="${m.image_url}" style="max-width:260px;margin-top:6px;border-radius:8px;">`:'';
    const ts=`<span class="ts">${new Date().toLocaleTimeString()}</span>`;
    return `<div class="msg ${mine?'me':'you'}"><div class="bubble">${text}${img}${ts}</div></div>`;
  }).join('');
  box.scrollTop=box.scrollHeight;
}

function logout(){ try{ localStorage.removeItem('auth_token'); } catch{}; try{ if(ws && ws.readyState===WebSocket.OPEN) ws.close(); } catch{}; location.href='/ui/login.html'; }

window.addEventListener('DOMContentLoaded',()=>{
  token=localStorage.getItem('auth_token');
  if(!token) location.href='/ui/login.html';
  me().then(loadUsers).then(connectWs);
});
</script>
</body>
</html>




